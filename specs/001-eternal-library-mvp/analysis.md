# 跨產物一致性分析報告

**功能分支**：`001-eternal-library-mvp`
**分析日期**：2025-12-16
**分析範圍**：spec.md、plan.md、tasks.md、data-model.md、constitution.md

---

## 執行摘要

| 指標 | 數值 |
|------|------|
| **總發現數** | 8 |
| **CRITICAL** | 1 |
| **HIGH** | 2 |
| **MEDIUM** | 3 |
| **LOW** | 2 |
| **需求覆蓋率** | 96.4%（27/28 FR） |
| **User Story 覆蓋率** | 100%（5/5 US） |

---

## 發現清單

| ID | 嚴重度 | 類型 | 位置 | 描述 | 建議修復 |
|----|--------|------|------|------|----------|
| F-001 | **CRITICAL** | 憲章衝突 | plan.md:89-90 vs constitution.md:117 | Bundle Size 限制不一致：憲章要求 `< 500KB gzipped（總計）`，但 plan.md 放寬為 `首頁 < 500KB + 完整 < 800KB`。此變更需憲章修訂流程核准。 | 1) 提交憲章修訂提案，將效能標準更新為雙層 Bundle 限制；或 2) 評估 Phaser 替代方案以符合現有限制 |
| F-002 | **HIGH** | 覆蓋缺口 | spec.md:FR-004 | 「靜默自動重連」需求未在 tasks.md 中有明確對應任務。T036 提及「自動重連邏輯」但未明確包含「靜默」行為規格。 | 在 T036 任務描述中明確加入：「靜默嘗試自動重連，失敗不提示」 |
| F-003 | **HIGH** | 規格缺漏 | plan.md:155-176 | EventBridge 通訊協定定義了事件名稱，但缺乏：1) 事件 payload 結構；2) 錯誤處理機制；3) 超時處理。 | 補充 EventBridge API 規格至 contracts/frontend-api.md，包含完整 payload 定義 |
| F-004 | **MEDIUM** | 術語不一致 | 跨文件 | 「遊戲引擎」vs「Phaser」vs「Phaser 3」命名不統一。spec.md 未提及 Phaser，plan.md 和 tasks.md 才引入。 | 在 spec.md 技術決策摘要中補充遊戲引擎選擇，統一使用「Phaser 3」 |
| F-005 | **MEDIUM** | 規格缺漏 | spec.md:US4 | 「鑄造成功慶祝動畫」在 spec.md AC 中僅提及「播放慶祝動畫」，但 plan.md 定義了具體效果（煙火、金幣飛散）。AC 應與設計對齊。 | 更新 spec.md US4-AC2 為：「播放慶祝動畫（煙火爆發、金幣飛散效果）」 |
| F-006 | **MEDIUM** | 潛在重疊 | tasks.md:T065 vs T073 | DrawResultOverlay 在兩處被修改：T065 建立初始版本，T073 加入鑄造按鈕。應明確定義初始版本是否包含按鈕佔位。 | 在 T065 描述中加入「預留鑄造按鈕位置」，或合併至 T073 |
| F-007 | **LOW** | 效能假設 | plan.md:187-188 | Bundle Size 預估 `首頁總計 ~330KB` 未考慮 @iota/iota-sdk 大小（可能額外 50-100KB）。 | 進行實際 Bundle 分析驗證預估，調整 plan 數據 |
| F-008 | **LOW** | 文件同步 | constitution.md vs constitution_zh-tw.md | constitution.md（英文）與 constitution_zh-tw.md（繁體中文）需保持同步。目前版本一致但應建立同步機制。 | 在 CLAUDE.md 規則已有定義，確保每次修改都同步兩份文件 |

---

## 需求覆蓋率矩陣

### User Story 1 - 錢包連接（FR-001 ~ FR-005）

| 需求 | 任務 | 狀態 | 備註 |
|------|------|------|------|
| FR-001 支援 IOTA Wallet 連接 | T031, T032 | ✅ | - |
| FR-002 顯示縮寫錢包地址 | T031 | ✅ | - |
| FR-003 支援斷開連接 | T031 | ✅ | - |
| FR-004 靜默自動重連 | T036 | ⚠️ | 描述待明確（F-002）|
| FR-005 帳號切換偵測 | T036 | ✅ | - |

### User Story 2 - 每日簽到（FR-006 ~ FR-009）

| 需求 | 任務 | 狀態 | 備註 |
|------|------|------|------|
| FR-006 每日 UTC+8 簽到 | T042, T044, T045 | ✅ | - |
| FR-007 發放 5 MGC | T042, T008 | ✅ | - |
| FR-008 計算連續天數 | T044 | ✅ | 從 Event Log 計算 |
| FR-009 禁用按鈕 + 倒計時 | T048, T051 | ✅ | - |

### User Story 3 - 抽取解答（FR-010 ~ FR-017）

| 需求 | 任務 | 狀態 | 備註 |
|------|------|------|------|
| FR-010 輸入問題 | T063 | ✅ | - |
| FR-011 扣除 10 MGC | T057, T059 | ✅ | - |
| FR-012 前端隨機選擇 | T056 | ✅ | - |
| FR-013 雙語答案顯示 | T058, T065 | ✅ | - |
| FR-014 稀有度視覺樣式 | T061, T065 | ✅ | - |
| FR-015 MGC 不足阻止 | T059 | ✅ | - |
| FR-016 Optimistic UI | T067 | ✅ | - |
| FR-017 上鏈記錄 | T057 | ✅ | - |

### User Story 4 - NFT 鑄造（FR-018 ~ FR-022）

| 需求 | 任務 | 狀態 | 備註 |
|------|------|------|------|
| FR-018 結果頁鑄造 | T073 | ✅ | - |
| FR-019 扣除 5 MGC + Gas | T070, T071 | ✅ | - |
| FR-020 銷毀 DrawRecord | T070 | ✅ | - |
| FR-021 NFT 內容完整性 | T070 | ✅ | - |
| FR-022 Explorer 連結 | T075 | ✅ | - |

### User Story 5 - 收藏展示（FR-023 ~ FR-028）

| 需求 | 任務 | 狀態 | 備註 |
|------|------|------|------|
| FR-023 導航列入口 | T034, T087 | ✅ | - |
| FR-024 網格展示 | T084 | ✅ | - |
| FR-025 詳情彈窗 | T085 | ✅ | - |
| FR-026 統計卡片 | T086 | ✅ | - |
| FR-027 響應式網格 | T089 | ✅ | - |
| FR-028 骨架屏 | T088 | ✅ | - |

---

## 憲章合規檢查

### I. 程式碼品質 ✅

| 原則 | plan.md 對應 | 合規 |
|------|--------------|------|
| 可讀性優先 | 有意義命名、自說明程式碼 | ✅ |
| SOLID 原則 | Hooks 分離關注點 | ✅ |
| 型別安全 | TypeScript strict mode | ✅ |
| 錯誤處理 | OracleError 類別 | ✅ |

### II. 測試紀律 ✅

| 原則 | tasks.md 對應 | 合規 |
|------|---------------|------|
| TDD 強制性 | 測試任務先於實作任務 | ✅ |
| 單元測試 | Move 合約測試、Hook 測試 | ✅ |
| 整合測試 | 元件測試 | ✅ |

### III. 使用者體驗一致性 ✅

| 原則 | plan.md 對應 | 合規 |
|------|--------------|------|
| 回饋 | Toast 通知、動畫效果 | ✅ |
| 錯誤訊息 | 中文、可操作、非技術性 | ✅ |
| 載入狀態 | 骨架屏、按鈕載入狀態 | ✅ |
| 響應式 | Tailwind 響應式設計 | ✅ |

### IV. 效能標準 ⚠️

| 原則 | plan.md 對應 | 合規 | 備註 |
|------|--------------|------|------|
| 回應時間 < 100ms | < 100ms（UI 操作）| ✅ | |
| 頁面載入 < 2s | < 3 秒 | ⚠️ | 放寬至 3 秒 |
| **套件大小 < 500KB** | **首頁 < 500KB + 完整 < 800KB** | ❌ | **F-001** |

### V. 文件語言 ✅

| 原則 | 實際狀態 | 合規 |
|------|----------|------|
| 繁體中文 zh-TW | 所有規格文件使用繁體中文 | ✅ |

---

## 技術分級一致性

### Phaser 場景對應

| 場景 | spec.md 提及 | plan.md 定義 | tasks.md 任務 | 狀態 |
|------|--------------|--------------|---------------|------|
| DrawScene | AC: 播放抽取動畫 | 卡牌飛入、能量粒子 | T060 | ✅ |
| CardRevealScene | AC: 稀有度視覺 | 3D 翻轉、稀有度爆發 | T061 | ✅ |
| CelebrationScene | AC: 播放慶祝動畫 | 煙火、金幣飛散 | T072 | ⚠️ F-005 |

### Framer Motion 元件對應

| 元件 | plan.md 分級 | tasks.md 任務 | 狀態 |
|------|--------------|---------------|------|
| BalanceDisplay | A 級 | T046 | ✅ |
| CheckInBook | A 級 | T047 | ✅ |
| Toast | A 級 | T021 | ✅ |
| PageTransition | A 級 | T022 | ✅ |
| NFTDetailModal | A 級 | T085 | ✅ |
| CollectionStats | A 級 | T086 | ✅ |

---

## 修復優先級建議

### 第一優先（阻擋實作）

1. **F-001** - 憲章 Bundle Size 衝突
   - **行動**：提交憲章修訂提案
   - **理由**：實作 Phaser 前必須解決治理問題

### 第二優先（實作前）

2. **F-002** - FR-004 自動重連任務明確化
   - **行動**：更新 T036 描述
   - **影響**：US1 實作完整性

3. **F-003** - EventBridge API 規格
   - **行動**：補充 frontend-api.md
   - **影響**：Phaser 整合實作

### 第三優先（可並行）

4. **F-004** - 術語統一
5. **F-005** - US4 AC 對齊
6. **F-006** - 任務重疊澄清

### 第四優先（持續改進）

7. **F-007** - Bundle 預估驗證
8. **F-008** - 文件同步機制

---

## 下一步行動

1. ⏳ **等待**：F-001 憲章修訂核准
2. 📝 **立即**：更新 tasks.md T036 描述（F-002）
3. 📝 **立即**：補充 EventBridge API 至 frontend-api.md（F-003）
4. 📝 **可選**：更新 spec.md 技術決策摘要（F-004、F-005）

---

## 附錄：語義模型摘要

### 需求清單（28 項）

| 範圍 | 需求數 | 覆蓋數 | 覆蓋率 |
|------|--------|--------|--------|
| US1 錢包連接 | 5 | 4.5 | 90% |
| US2 每日簽到 | 4 | 4 | 100% |
| US3 抽取解答 | 8 | 8 | 100% |
| US4 NFT 鑄造 | 5 | 5 | 100% |
| US5 收藏展示 | 6 | 6 | 100% |
| **總計** | **28** | **27.5** | **98.2%** |

### 任務分佈（98 項）

| Phase | 任務數 | 可平行 |
|-------|--------|--------|
| Phase 1 Setup | 6 | 3 |
| Phase 2 Foundational | 22 | 15 |
| Phase 3 US1 | 8 | 2 |
| Phase 4 US2 | 15 | 5 |
| Phase 5 US3 | 16 | 4 |
| Phase 6 US4 | 9 | 2 |
| Phase 7 US5 | 13 | 4 |
| Phase 8 Polish | 9 | 4 |

---

**報告產生時間**：2025-12-16
**分析工具**：speckit.analyze
