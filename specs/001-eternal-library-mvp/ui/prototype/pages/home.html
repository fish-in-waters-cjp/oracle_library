<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é  - æ°¸æ†åœ–æ›¸é¤¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/tokens.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/utilities.css">
    <link rel="stylesheet" href="../css/pages.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">æ°¸æ†åœ–æ›¸é¤¨</div>
            <nav class="nav-actions">
                <a href="collection.html" class="nav-link">æˆ‘çš„æ”¶è—</a>
                <div class="wallet-address" id="walletAddress">0x1234...5678</div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <h1 class="page-title">æ­¡è¿ä¾†åˆ°æ™ºæ…§çš„æ®¿å ‚</h1>

        <div class="cards-grid">
            <!-- MGC é¤˜é¡å¡ç‰‡ -->
            <div class="card">
                <h2 class="card-title">MGC é¤˜é¡</h2>
                <div class="balance-amount">
                    <span id="mgcBalance">1,250</span>
                    <span class="balance-unit">MGC</span>
                </div>
                <p class="text-muted text-sm">æ™ºæ…§ç¢ç‰‡ï¼ˆMagic Coinï¼‰</p>
            </div>

            <!-- æ¯æ—¥ç°½åˆ°å¡ç‰‡ -->
            <div class="card">
                <h2 class="card-title">æ¯æ—¥ç°½åˆ°</h2>
                <div class="checkin-info">
                    <div>
                        <div class="checkin-days">7 <span class="text-base">å¤©</span></div>
                        <div class="checkin-label">é€£çºŒç°½åˆ°</div>
                    </div>
                    <button class="btn btn-primary" id="checkinButton">ç°½åˆ°</button>
                </div>
            </div>

            <!-- æŠ½å–è§£ç­”å€å¡Šï¼ˆæ•´åˆ Phaserï¼‰-->
            <div class="card" style="grid-column: 1 / -1;">
                <h2 class="card-title">å‘åœ–æ›¸é¤¨æå•</h2>
                <textarea
                    id="questionInput"
                    class="question-input"
                    placeholder="åœ¨é€™è£¡è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œåœ–æ›¸é¤¨å°‡è³œäºˆæ‚¨æ™ºæ…§çš„è§£ç­”..."
                ></textarea>
                <div class="cost-info">ğŸ’ æ¯æ¬¡æŠ½å–æ¶ˆè€— 10 MGC</div>
                <button class="btn btn-primary btn-large btn-full" id="drawButton">æŠ½å–è§£ç­”</button>
            </div>
        </div>
    </main>

    <!-- Phaser éŠæˆ²å®¹å™¨ï¼ˆåˆå§‹éš±è—ï¼‰-->
    <div id="phaser-container" class="phaser-container hidden">
        <div id="phaser-game"></div>

        <!-- ç­”æ¡ˆè¦†è“‹å±¤ï¼ˆPhaser å®Œæˆå¾Œé¡¯ç¤ºï¼‰-->
        <div id="answer-overlay" class="answer-overlay">
            <div class="answer-card">
                <div class="answer-rarity">
                    <span id="rarityBadge" class="badge badge-common">æ™®é€š</span>
                </div>
                <p id="answerTextEn" class="answer-text-en">Patience is the companion of wisdom.</p>
                <p id="answerTextZh" class="answer-text-zh">è€å¿ƒæ˜¯æ™ºæ…§çš„å¤¥ä¼´ã€‚</p>
                <div class="answer-actions">
                    <button class="btn btn-secondary" id="skipButton">è·³é</button>
                    <button class="btn btn-primary btn-large" id="mintButton">é‘„é€  NFTï¼ˆ5 MGCï¼‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="toast hidden">
        <div class="toast-title" id="toastTitle">é€šçŸ¥</div>
        <div class="toast-message" id="toastMessage">è¨Šæ¯å…§å®¹</div>
    </div>

    <!-- Scripts -->
    <script src="../js/phaser-loader.js"></script>
    <script src="../js/phaser/event-bridge.js"></script>
    <script src="../js/phaser/game-config.js"></script>

    <!-- å ´æ™¯è…³æœ¬å°‡åœ¨ Phaser è¼‰å…¥å¾Œå‹•æ…‹è¼‰å…¥ -->
    <script>
        // ===== ç‹€æ…‹ç®¡ç† =====
        let currentMGC = 1250;
        let hasCheckedIn = false;
        let phaserInitialized = false;
        let currentAnswer = null;

        // ===== DOM å…ƒç´  =====
        const elements = {
            mgcBalance: document.getElementById('mgcBalance'),
            walletAddress: document.getElementById('walletAddress'),
            checkinButton: document.getElementById('checkinButton'),
            questionInput: document.getElementById('questionInput'),
            drawButton: document.getElementById('drawButton'),
            phaserContainer: document.getElementById('phaser-container'),
            answerOverlay: document.getElementById('answer-overlay'),
            rarityBadge: document.getElementById('rarityBadge'),
            answerTextEn: document.getElementById('answerTextEn'),
            answerTextZh: document.getElementById('answerTextZh'),
            mintButton: document.getElementById('mintButton'),
            skipButton: document.getElementById('skipButton'),
            toast: document.getElementById('toast'),
            toastTitle: document.getElementById('toastTitle'),
            toastMessage: document.getElementById('toastMessage')
        };

        // ===== åˆå§‹åŒ– =====
        function init() {
            // æª¢æŸ¥éŒ¢åŒ…é€£æ¥
            const walletAddress = localStorage.getItem('walletAddress');
            if (walletAddress) {
                elements.walletAddress.textContent = walletAddress;
            }

            // è¼‰å…¥ MGC é¤˜é¡
            updateMGCBalance(currentMGC);

            // ç¶å®šäº‹ä»¶
            elements.checkinButton.addEventListener('click', handleCheckin);
            elements.drawButton.addEventListener('click', handleDraw);
            elements.mintButton.addEventListener('click', handleMint);
            elements.skipButton.addEventListener('click', handleSkip);

            // ç›£è½ Phaser äº‹ä»¶
            eventBridge.on(EVENTS.DRAW_COMPLETE, onDrawComplete);
            eventBridge.on(EVENTS.CARD_REVEALED, onCardRevealed);
            eventBridge.on(EVENTS.CELEBRATION_DONE, onCelebrationDone);

            console.log('âœ… ä¸»é åˆå§‹åŒ–å®Œæˆ');
        }

        // ===== ç°½åˆ°åŠŸèƒ½ =====
        function handleCheckin() {
            if (hasCheckedIn) {
                showToast('æç¤º', 'ä»Šå¤©å·²ç¶“ç°½åˆ°éäº†', 'info');
                return;
            }

            elements.checkinButton.disabled = true;
            elements.checkinButton.classList.add('btn-loading');

            setTimeout(() => {
                hasCheckedIn = true;
                currentMGC += 5;
                updateMGCBalance(currentMGC);

                elements.checkinButton.classList.remove('btn-loading');
                elements.checkinButton.textContent = 'å·²ç°½åˆ° âœ“';
                elements.checkinButton.style.opacity = '0.6';

                showToast('ç°½åˆ°æˆåŠŸ', 'æ‚¨ç²å¾—äº† 5 MGC', 'success');
            }, 1000);
        }

        // ===== æŠ½å–è§£ç­”åŠŸèƒ½ =====
        async function handleDraw() {
            const question = elements.questionInput.value.trim();

            // é©—è­‰å•é¡Œ
            if (!question) {
                showToast('æç¤º', 'è«‹å…ˆè¼¸å…¥æ‚¨çš„å•é¡Œ', 'warning');
                elements.questionInput.focus();
                return;
            }

            // é©—è­‰é¤˜é¡
            if (currentMGC < 10) {
                showToast('é¤˜é¡ä¸è¶³', `éœ€è¦ 10 MGCï¼Œæ‚¨ç›®å‰æœ‰ ${currentMGC} MGC`, 'error');
                return;
            }

            // æ‰£é™¤ MGC
            currentMGC -= 10;
            updateMGCBalance(currentMGC);

            // ç¦ç”¨æŒ‰éˆ•
            elements.drawButton.disabled = true;
            elements.drawButton.classList.add('btn-loading');

            // éš¨æ©Ÿç¨€æœ‰åº¦
            const rarity = getRandomRarity();
            console.log('ğŸ² æŠ½å–ç¨€æœ‰åº¦:', rarity);

            // éš¨æ©Ÿç­”æ¡ˆ
            currentAnswer = getRandomAnswer(rarity, question);
            console.log('ğŸ“– æŠ½å–ç­”æ¡ˆ:', currentAnswer);

            // é¡¯ç¤º Phaser å®¹å™¨
            elements.phaserContainer.classList.remove('hidden');

            try {
                // æ‡¶è¼‰å…¥ Phaser ä¸¦åˆå§‹åŒ–éŠæˆ²
                if (!phaserInitialized) {
                    await initializePhaser(rarity);
                } else {
                    // é‡å•Ÿå ´æ™¯
                    const game = getPhaserGame();
                    game.scene.start('DrawScene', { rarity });
                }
            } catch (error) {
                console.error('âŒ Phaser åˆå§‹åŒ–å¤±æ•—:', error);
                showToast('éŒ¯èª¤', 'Phaser è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                hidePhaserContainer();
            }
        }

        // ===== åˆå§‹åŒ– Phaser =====
        async function initializePhaser(rarity) {
            console.log('ğŸ® é–‹å§‹åˆå§‹åŒ– Phaser...');

            try {
                // 1. è¼‰å…¥ Phaser CDN
                await loadPhaser();
                console.log('âœ… Phaser CDN è¼‰å…¥æˆåŠŸ');

                // 2. å‹•æ…‹è¼‰å…¥å ´æ™¯è…³æœ¬
                await loadSceneScripts();
                console.log('âœ… å ´æ™¯è…³æœ¬è¼‰å…¥æˆåŠŸ');

                // 3. å»ºç«‹éŠæˆ²é…ç½®
                const config = createGameConfig('phaser-game');
                config.scene = [DrawScene, CardRevealScene, CelebrationScene];

                // 4. åˆå§‹åŒ–éŠæˆ²
                const game = await initPhaserGame(config);
                eventBridge.setGame(game);

                phaserInitialized = true;
                console.log('âœ… Phaser åˆå§‹åŒ–å®Œæˆ');

                // 5. å•Ÿå‹• DrawScene
                game.scene.start('DrawScene', { rarity });
            } catch (error) {
                console.error('âŒ Phaser åˆå§‹åŒ–å¤±æ•—:', error);
                throw error;
            }
        }

        // ===== å‹•æ…‹è¼‰å…¥å ´æ™¯è…³æœ¬ =====
        function loadSceneScripts() {
            const scripts = [
                '../js/phaser/scenes/DrawScene.js',
                '../js/phaser/scenes/CardRevealScene.js',
                '../js/phaser/scenes/CelebrationScene.js'
            ];

            return Promise.all(scripts.map(src => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        console.log(`âœ… è¼‰å…¥å ´æ™¯: ${src}`);
                        resolve();
                    };
                    script.onerror = (error) => {
                        console.error(`âŒ è¼‰å…¥å ´æ™¯å¤±æ•—: ${src}`, error);
                        reject(error);
                    };
                    document.body.appendChild(script);
                });
            }));
        }

        // ===== Phaser äº‹ä»¶è™•ç† =====
        function onDrawComplete(data) {
            console.log('âœ… æŠ½å–å‹•ç•«å®Œæˆ', data);
        }

        function onCardRevealed(data) {
            console.log('âœ… å¡ç‰‡æ­ç¤ºå®Œæˆ', data);

            // é¡¯ç¤ºç­”æ¡ˆè¦†è“‹å±¤
            setTimeout(() => {
                displayAnswer(currentAnswer);
                elements.answerOverlay.classList.add('show');
            }, 500);
        }

        function onCelebrationDone(data) {
            console.log('âœ… æ…¶ç¥å‹•ç•«å®Œæˆ', data);

            // è·³è½‰åˆ°æ”¶è—é 
            setTimeout(() => {
                window.location.href = 'collection.html';
            }, 500);
        }

        // ===== é¡¯ç¤ºç­”æ¡ˆ =====
        function displayAnswer(answer) {
            // è¨­å®šç¨€æœ‰åº¦å¾½ç« 
            const badgeClasses = {
                common: 'badge-common',
                rare: 'badge-rare',
                epic: 'badge-epic',
                legendary: 'badge-legendary'
            };

            elements.rarityBadge.className = `badge ${badgeClasses[answer.rarity]}`;
            elements.rarityBadge.textContent = getRarityName(answer.rarity);

            // è¨­å®šç­”æ¡ˆæ–‡å­—
            elements.answerTextEn.textContent = answer.en;
            elements.answerTextZh.textContent = answer.zh;
        }

        // ===== é‘„é€  NFT =====
        function handleMint() {
            // é©—è­‰é¤˜é¡
            if (currentMGC < 5) {
                showToast('é¤˜é¡ä¸è¶³', `é‘„é€  NFT éœ€è¦ 5 MGCï¼Œæ‚¨ç›®å‰æœ‰ ${currentMGC} MGC`, 'error');
                return;
            }

            // æ‰£é™¤ MGC
            currentMGC -= 5;
            updateMGCBalance(currentMGC);

            // éš±è—ç­”æ¡ˆè¦†è“‹å±¤
            elements.answerOverlay.classList.remove('show');

            // ç¦ç”¨æŒ‰éˆ•
            elements.mintButton.disabled = true;
            elements.mintButton.classList.add('btn-loading');

            // æ¨¡æ“¬é‘„é€ å»¶é²
            setTimeout(() => {
                // å•Ÿå‹•æ…¶ç¥å ´æ™¯
                const game = getPhaserGame();
                game.scene.stop('CardRevealScene');
                game.scene.start('CelebrationScene');

                console.log('ğŸ‰ é–‹å§‹æ…¶ç¥å‹•ç•«');
            }, 1000);
        }

        // ===== è·³éé‘„é€  =====
        function handleSkip() {
            hidePhaserContainer();
            showToast('å·²è·³é', 'ç­”æ¡ˆæœªä¿å­˜ï¼Œæ‚¨å¯ä»¥ç¹¼çºŒæå•', 'info');
        }

        // ===== éš±è— Phaser å®¹å™¨ =====
        function hidePhaserContainer() {
            elements.phaserContainer.classList.add('hidden');
            elements.answerOverlay.classList.remove('show');

            // åœæ­¢å ´æ™¯
            if (phaserInitialized) {
                const game = getPhaserGame();
                game.scene.stop('DrawScene');
                game.scene.stop('CardRevealScene');
                game.scene.stop('CelebrationScene');
            }

            // é‡ç½®æŒ‰éˆ•
            elements.drawButton.disabled = false;
            elements.drawButton.classList.remove('btn-loading');
            elements.mintButton.disabled = false;
            elements.mintButton.classList.remove('btn-loading');
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function updateMGCBalance(amount) {
            elements.mgcBalance.textContent = amount.toLocaleString();
        }

        function getRandomRarity() {
            const rand = Math.random();
            if (rand < 0.5) return 'common';      // 50%
            if (rand < 0.8) return 'rare';        // 30%
            if (rand < 0.95) return 'epic';       // 15%
            return 'legendary';                    // 5%
        }

        function getRandomAnswer(rarity, question) {
            const answers = {
                common: [
                    { en: 'Patience is the companion of wisdom.', zh: 'è€å¿ƒæ˜¯æ™ºæ…§çš„å¤¥ä¼´ã€‚' },
                    { en: 'Knowledge is power.', zh: 'çŸ¥è­˜å°±æ˜¯åŠ›é‡ã€‚' },
                    { en: 'The journey of a thousand miles begins with one step.', zh: 'åƒé‡Œä¹‹è¡Œï¼Œå§‹æ–¼è¶³ä¸‹ã€‚' }
                ],
                rare: [
                    { en: 'The only true wisdom is in knowing you know nothing.', zh: 'å”¯ä¸€çœŸæ­£çš„æ™ºæ…§æ˜¯çŸ¥é“è‡ªå·±ä¸€ç„¡æ‰€çŸ¥ã€‚' },
                    { en: 'In the midst of chaos, there is also opportunity.', zh: 'å±æ©Ÿä¹‹ä¸­ï¼Œå¿…æœ‰è½‰æ©Ÿã€‚' }
                ],
                epic: [
                    { en: 'The mind is everything. What you think you become.', zh: 'å¿ƒéˆå°±æ˜¯ä¸€åˆ‡ï¼Œä½ æ‰€æƒ³çš„ï¼Œä½ å°±æœƒæˆç‚ºã€‚' }
                ],
                legendary: [
                    { en: 'The unexamined life is not worth living.', zh: 'æœªç¶“å¯©è¦–çš„äººç”Ÿä¸å€¼å¾—æ´»ã€‚' }
                ]
            };

            const pool = answers[rarity] || answers.common;
            const selected = pool[Math.floor(Math.random() * pool.length)];

            return {
                rarity,
                question,
                ...selected,
                timestamp: new Date().toISOString()
            };
        }

        function showToast(title, message, type = 'info') {
            elements.toastTitle.textContent = title;
            elements.toastMessage.textContent = message;
            elements.toast.className = `toast toast-${type}`;
            elements.toast.classList.remove('hidden');

            setTimeout(() => {
                elements.toast.classList.add('hidden');
            }, 3000);
        }

        // ===== å•Ÿå‹• =====
        init();
    </script>
</body>
</html>
