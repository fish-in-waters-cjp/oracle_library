<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phaser 3 æ•ˆæœæ¼”ç¤º - æ°¸æ†åœ–æ›¸é¤¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/tokens.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/utilities.css">
    <link rel="stylesheet" href="../css/pages.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">æ°¸æ†åœ–æ›¸é¤¨ - Phaser æ¼”ç¤º</div>
            <nav class="nav-actions">
                <a href="../index.html" class="nav-link">è¿”å›ç¸½è¦½</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <h1 class="page-title">Phaser 3 éŠæˆ²å ´æ™¯æ¼”ç¤º</h1>

        <!-- DrawScene æ¼”ç¤º -->
        <section class="demo-section">
            <div class="card">
                <h2 class="card-title">DrawScene - æŠ½å–å‹•ç•«å ´æ™¯</h2>
                <p class="card-body">å¡ç‰Œé£›å…¥ã€èƒ½é‡ç²’å­èšé›†ã€3D ç¿»è½‰ã€ç¨€æœ‰åº¦çˆ†ç™¼æ•ˆæœã€‚æŒçºŒ 3-5 ç§’ã€‚</p>

                <div class="demo-controls">
                    <button class="btn btn-primary" onclick="startDrawScene('common')">
                        <span class="badge badge-common">æ™®é€š</span> æŠ½å–
                    </button>
                    <button class="btn btn-primary" onclick="startDrawScene('rare')">
                        <span class="badge badge-rare">ç¨€æœ‰</span> æŠ½å–
                    </button>
                    <button class="btn btn-primary" onclick="startDrawScene('epic')">
                        <span class="badge badge-epic">å²è©©</span> æŠ½å–
                    </button>
                    <button class="btn btn-primary" onclick="startDrawScene('legendary')">
                        <span class="badge badge-legendary">å‚³èªª</span> æŠ½å–
                    </button>
                </div>
            </div>
        </section>

        <!-- CardRevealScene æ¼”ç¤º -->
        <section class="demo-section">
            <div class="card">
                <h2 class="card-title">CardRevealScene - å¡ç‰‡æ­ç¤ºå ´æ™¯</h2>
                <p class="card-body">æŒçºŒçš„å…‰æ•ˆç’°ç¹ã€ç²’å­æ•ˆæœæ ¹æ“šç¨€æœ‰åº¦è®ŠåŒ–ã€‚ä½èª¿å„ªé›…çš„å‹•ç•«ã€‚</p>

                <div class="demo-controls">
                    <button class="btn btn-secondary" onclick="startRevealScene('common')">
                        <span class="badge badge-common">æ™®é€š</span> æ­ç¤º
                    </button>
                    <button class="btn btn-secondary" onclick="startRevealScene('rare')">
                        <span class="badge badge-rare">ç¨€æœ‰</span> æ­ç¤º
                    </button>
                    <button class="btn btn-secondary" onclick="startRevealScene('epic')">
                        <span class="badge badge-epic">å²è©©</span> æ­ç¤º
                    </button>
                    <button class="btn btn-secondary" onclick="startRevealScene('legendary')">
                        <span class="badge badge-legendary">å‚³èªª</span> æ­ç¤º
                    </button>
                    <button class="btn btn-secondary" onclick="stopAllScenes()">åœæ­¢å ´æ™¯</button>
                </div>
            </div>
        </section>

        <!-- CelebrationScene æ¼”ç¤º -->
        <section class="demo-section">
            <div class="card">
                <h2 class="card-title">CelebrationScene - æ…¶ç¥å ´æ™¯</h2>
                <p class="card-body">ç…™ç«æ•ˆæœã€é‡‘å¹£é£›æ•£ã€å…‰èŠ’çˆ†ç™¼ã€‚æŒçºŒ 2-3 ç§’ã€‚</p>

                <div class="demo-controls">
                    <button class="btn btn-primary btn-large" onclick="startCelebrationScene()">
                        ğŸ‰ é–‹å§‹æ…¶ç¥
                    </button>
                </div>
            </div>
        </section>

        <!-- Phaser é è¦½ -->
        <section class="demo-section">
            <div class="card">
                <h2 class="card-title">éŠæˆ²é è¦½</h2>
                <div id="demo-preview" class="demo-preview">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--color-text-muted);">
                        é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä»¥å•Ÿå‹• Phaser å ´æ™¯
                    </div>
                </div>
            </div>
        </section>

        <!-- äº‹ä»¶æ—¥èªŒ -->
        <section class="demo-section">
            <div class="card">
                <h2 class="card-title">äº‹ä»¶æ—¥èªŒ</h2>
                <div class="event-log">
                    <div class="event-log-title">React â†” Phaser äº‹ä»¶é€šè¨Š</div>
                    <div id="eventLog" style="font-family: var(--font-mono); font-size: var(--text-xs);">
                        <div style="color: var(--color-text-muted); padding: var(--space-4);">ç­‰å¾…äº‹ä»¶...</div>
                    </div>
                </div>
                <div style="margin-top: var(--space-4); display: flex; gap: var(--space-4);">
                    <button class="btn btn-small btn-secondary" onclick="clearEventLog()">æ¸…é™¤æ—¥èªŒ</button>
                    <button class="btn btn-small btn-secondary" onclick="exportEventLog()">åŒ¯å‡ºæ—¥èªŒ</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="../js/phaser-loader.js"></script>
    <script src="../js/phaser/event-bridge.js"></script>
    <script src="../js/phaser/game-config.js"></script>

    <!-- å ´æ™¯è…³æœ¬å°‡åœ¨ Phaser è¼‰å…¥å¾Œå‹•æ…‹è¼‰å…¥ -->
    <script>
        let phaserInitialized = false;

        // åˆå§‹åŒ– Phaser
        async function initPhaser() {
            if (phaserInitialized) return;

            logEvent('SYSTEM', 'Phaser åˆå§‹åŒ–é–‹å§‹');

            try {
                // 1. è¼‰å…¥ Phaser CDN
                await loadPhaser();
                logEvent('SYSTEM', 'Phaser CDN è¼‰å…¥æˆåŠŸ');

                // 2. å‹•æ…‹è¼‰å…¥å ´æ™¯è…³æœ¬
                await loadSceneScripts();
                logEvent('SYSTEM', 'å ´æ™¯è…³æœ¬è¼‰å…¥æˆåŠŸ');

                // 3. å»ºç«‹éŠæˆ²é…ç½®
                const config = createGameConfig('demo-preview');
                config.scene = [DrawScene, CardRevealScene, CelebrationScene];

                // 4. åˆå§‹åŒ–éŠæˆ²
                const game = await initPhaserGame(config);
                eventBridge.setGame(game);

                phaserInitialized = true;
                logEvent('SYSTEM', 'Phaser åˆå§‹åŒ–å®Œæˆ');

                // 5. ç›£è½æ‰€æœ‰äº‹ä»¶
                setupEventListeners();
            } catch (error) {
                logEvent('ERROR', 'Phaser åˆå§‹åŒ–å¤±æ•—: ' + error.message);
                throw error;
            }
        }

        // å‹•æ…‹è¼‰å…¥å ´æ™¯è…³æœ¬
        function loadSceneScripts() {
            const scripts = [
                '../js/phaser/scenes/DrawScene.js',
                '../js/phaser/scenes/CardRevealScene.js',
                '../js/phaser/scenes/CelebrationScene.js'
            ];

            return Promise.all(scripts.map(src => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        logEvent('SYSTEM', `å ´æ™¯è¼‰å…¥: ${src.split('/').pop()}`);
                        resolve();
                    };
                    script.onerror = (error) => {
                        logEvent('ERROR', `å ´æ™¯è¼‰å…¥å¤±æ•—: ${src.split('/').pop()}`);
                        reject(error);
                    };
                    document.body.appendChild(script);
                });
            }));
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            eventBridge.on(EVENTS.DRAW_COMPLETE, (data) => {
                logEvent('IN', 'DRAW_COMPLETE', data);
            });

            eventBridge.on(EVENTS.CARD_REVEALED, (data) => {
                logEvent('IN', 'CARD_REVEALED', data);
            });

            eventBridge.on(EVENTS.CELEBRATION_DONE, (data) => {
                logEvent('IN', 'CELEBRATION_DONE', data);
            });
        }

        // å•Ÿå‹• DrawScene
        async function startDrawScene(rarity) {
            await initPhaser();

            logEvent('OUT', 'START_DRAW', { rarity });

            const game = getPhaserGame();
            game.scene.stop('CardRevealScene');
            game.scene.stop('CelebrationScene');
            game.scene.start('DrawScene', { rarity });
        }

        // å•Ÿå‹• CardRevealScene
        async function startRevealScene(rarity) {
            await initPhaser();

            logEvent('OUT', 'REVEAL_CARD', { rarity });

            const game = getPhaserGame();
            game.scene.stop('DrawScene');
            game.scene.stop('CelebrationScene');
            game.scene.start('CardRevealScene', { rarity });
        }

        // å•Ÿå‹• CelebrationScene
        async function startCelebrationScene() {
            await initPhaser();

            logEvent('OUT', 'START_CELEBRATION', {});

            const game = getPhaserGame();
            game.scene.stop('DrawScene');
            game.scene.stop('CardRevealScene');
            game.scene.start('CelebrationScene');
        }

        // åœæ­¢æ‰€æœ‰å ´æ™¯
        function stopAllScenes() {
            if (!phaserInitialized) return;

            logEvent('OUT', 'STOP_SCENE', {});

            const game = getPhaserGame();
            game.scene.stop('DrawScene');
            game.scene.stop('CardRevealScene');
            game.scene.stop('CelebrationScene');
        }

        // è¨˜éŒ„äº‹ä»¶
        function logEvent(direction, eventName, data = {}) {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logContainer = document.getElementById('eventLog');

            const logItem = document.createElement('div');
            logItem.className = `event-log-item event-${direction.toLowerCase()}`;

            const dataStr = Object.keys(data).length > 0 ? JSON.stringify(data) : '';
            logItem.innerHTML = `
                <span style="color: var(--color-text-muted);">[${timestamp}]</span>
                <span style="color: ${direction === 'OUT' ? 'var(--color-primary)' : 'var(--color-success)'};">${direction === 'OUT' ? 'â†’' : 'â†'}</span>
                <span style="color: var(--color-text-primary);">${eventName}</span>
                ${dataStr ? `<span style="color: var(--color-text-muted); margin-left: var(--space-2);">${dataStr}</span>` : ''}
            `;

            logContainer.appendChild(logItem);

            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            logContainer.scrollTop = logContainer.scrollHeight;

            // åªä¿ç•™æœ€è¿‘ 50 æ¢
            const items = logContainer.querySelectorAll('.event-log-item');
            if (items.length > 50) {
                items[0].remove();
            }
        }

        // æ¸…é™¤äº‹ä»¶æ—¥èªŒ
        function clearEventLog() {
            const logContainer = document.getElementById('eventLog');
            logContainer.innerHTML = '<div style="color: var(--color-text-muted); padding: var(--space-4);">æ—¥èªŒå·²æ¸…é™¤</div>';
            eventBridge.clearLog();
        }

        // åŒ¯å‡ºäº‹ä»¶æ—¥èªŒ
        function exportEventLog() {
            const logs = eventBridge.getEventLog();
            const json = JSON.stringify(logs, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `phaser-event-log-${Date.now()}.json`;
            a.click();

            URL.revokeObjectURL(url);

            logEvent('SYSTEM', 'EVENT_LOG_EXPORTED', { count: logs.length });
        }

        // åˆå§‹åŒ–æ—¥èªŒ
        logEvent('SYSTEM', 'Demo Page Loaded');
    </script>
</body>
</html>
